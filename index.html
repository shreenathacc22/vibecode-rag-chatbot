<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>RAG Chatbot with Session Management</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      height: 100vh;
      display: flex;
      background: #f5f5f5;
    }
    #sidebar {
      width: 280px;
      background: #2c3e50;
      color: white;
      display: flex;
      flex-direction: column;
      border-right: 1px solid #34495e;
    }
    #sidebar-header {
      padding: 20px;
      background: #34495e;
      border-bottom: 1px solid #2c3e50;
    }
    #sidebar-header h2 {
      font-size: 18px;
      margin-bottom: 10px;
    }
    #new-chat-btn {
      width: 100%;
      padding: 10px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
    }
    #new-chat-btn:hover {
      background: #2980b9;
    }
    #conversation-list {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
    }
    .conversation-item {
      padding: 12px;
      margin-bottom: 8px;
      background: #34495e;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .conversation-item:hover {
      background: #3d566e;
    }
    .conversation-item.active {
      background: #3498db;
    }
    .conversation-title {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 4px;
    }
    .conversation-preview {
      font-size: 12px;
      color: #bdc3c7;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .conversation-meta {
      font-size: 11px;
      color: #95a5a6;
      margin-top: 4px;
    }
    #main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: white;
    }
    #header {
      padding: 20px;
      background: white;
      border-bottom: 1px solid #ecf0f1;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    #header h1 {
      font-size: 24px;
      color: #2c3e50;
      margin-bottom: 10px;
    }
    #current-session-info {
      font-size: 14px;
      color: #7f8c8d;
    }
    #upload {
      padding: 15px 20px;
      background: #ecf0f1;
      border-bottom: 1px solid #bdc3c7;
    }
    #upload h3 {
      font-size: 14px;
      margin-bottom: 10px;
      color: #2c3e50;
    }
    #uploadForm {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    #files {
      flex: 1;
      padding: 8px;
      border: 1px solid #bdc3c7;
      border-radius: 4px;
      font-size: 13px;
    }
    #uploadForm button {
      padding: 8px 20px;
      background: #27ae60;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
    }
    #uploadForm button:hover {
      background: #229954;
    }
    #uploadStatus {
      margin-top: 10px;
      font-size: 12px;
      color: #7f8c8d;
    }
    #chat {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 20px;
      overflow: hidden;
    }
    #messages {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
      margin-bottom: 15px;
    }
    .message {
      margin-bottom: 15px;
      display: flex;
      flex-direction: column;
    }
    .message-header {
      font-weight: 600;
      font-size: 12px;
      margin-bottom: 5px;
      color: #7f8c8d;
    }
    .message-content {
      padding: 10px 15px;
      border-radius: 8px;
      max-width: 80%;
      word-wrap: break-word;
    }
    .message.user .message-content {
      background: #3498db;
      color: white;
      margin-left: auto;
    }
    .message.bot .message-content {
      background: white;
      border: 1px solid #ecf0f1;
      color: #2c3e50;
    }
    .message-meta {
      font-size: 10px;
      color: #95a5a6;
      margin-top: 5px;
    }
    #input-area {
      display: flex;
      gap: 10px;
    }
    #input {
      flex: 1;
      padding: 12px;
      border: 1px solid #bdc3c7;
      border-radius: 6px;
      font-size: 14px;
    }
    #send {
      padding: 12px 30px;
      background: #3498db;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
    }
    #send:hover {
      background: #2980b9;
    }
    .no-conversations {
      text-align: center;
      padding: 40px 20px;
      color: #7f8c8d;
    }
    ::-webkit-scrollbar {
      width: 8px;
    }
    ::-webkit-scrollbar-track {
      background: #ecf0f1;
    }
    ::-webkit-scrollbar-thumb {
      background: #95a5a6;
      border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb:hover {
      background: #7f8c8d;
    }
  </style>
</head>
<body>
  <div id="sidebar">
    <div id="sidebar-header">
      <h2>Chat Sessions</h2>
      <button id="new-chat-btn">+ New Chat</button>
    </div>
    <div id="conversation-list">
      <div class="no-conversations">No conversations yet</div>
    </div>
  </div>

  <div id="main-content">
    <div id="header">
      <h1>RAG Chatbot</h1>
      <div id="current-session-info">Current Session: <span id="current-convo-id">-</span></div>
    </div>

    <div id="upload">
      <h3>üìÑ Upload Documents for RAG</h3>
      <form id="uploadForm">
        <input type="file" id="files" name="files" multiple accept=".pdf,.txt" />
        <button type="submit">Upload</button>
      </form>
      <div id="uploadStatus"></div>
    </div>

    <div id="chat">
      <div id="messages"></div>
      <div id="input-area">
        <input id="input" placeholder="Type your message..." autofocus />
        <button id="send">Send</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script>
    // Use dynamic URL based on current location
    const API_URL = window.location.origin;
    const socket = io(API_URL);
    const userId = 'demo-user';
    let currentConvoId = null;

    const messagesEl = document.getElementById('messages');
    const uploadForm = document.getElementById('uploadForm');
    const uploadStatus = document.getElementById('uploadStatus');
    const conversationList = document.getElementById('conversation-list');
    const currentConvoIdEl = document.getElementById('current-convo-id');
    const newChatBtn = document.getElementById('new-chat-btn');
    const sendBtn = document.getElementById('send');
    const inputEl = document.getElementById('input');

    // Generate a unique conversation ID
    function generateConvoId() {
      return `chat-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
    }

    // Format timestamp
    function formatTime(date) {
      const d = new Date(date);
      const now = new Date();
      const diff = now - d;
      const minutes = Math.floor(diff / 60000);
      const hours = Math.floor(diff / 3600000);
      const days = Math.floor(diff / 86400000);

      if (minutes < 1) return 'Just now';
      if (minutes < 60) return `${minutes}m ago`;
      if (hours < 24) return `${hours}h ago`;
      if (days < 7) return `${days}d ago`;
      return d.toLocaleDateString();
    }

    // Load conversations from server
    async function loadConversations() {
      try {
        const res = await fetch(`${API_URL}/conversations/${userId}`);
        const data = await res.json();

        if (data.conversations && data.conversations.length > 0) {
          conversationList.innerHTML = '';
          data.conversations.forEach(conv => {
            addConversationToList(conv);
          });
        } else {
          conversationList.innerHTML = '<div class="no-conversations">No conversations yet.<br>Click "New Chat" to start!</div>';
        }
      } catch (err) {
        console.error('Error loading conversations:', err);
      }
    }

    // Add conversation to sidebar
    function addConversationToList(conv) {
      const existing = document.querySelector(`[data-convo-id="${conv.convoId}"]`);
      if (existing) {
        existing.remove();
      }

      const div = document.createElement('div');
      div.className = 'conversation-item';
      if (conv.convoId === currentConvoId) {
        div.classList.add('active');
      }
      div.setAttribute('data-convo-id', conv.convoId);
      div.innerHTML = `
        <div class="conversation-title">${conv.convoId.replace('chat-', 'Chat #')}</div>
        <div class="conversation-preview">${conv.lastMessage.substring(0, 50)}${conv.lastMessage.length > 50 ? '...' : ''}</div>
        <div class="conversation-meta">${conv.messageCount} messages ‚Ä¢ ${formatTime(conv.lastMessageTime)}</div>
      `;
      div.onclick = () => switchConversation(conv.convoId);

      const firstChild = conversationList.firstChild;
      if (firstChild && firstChild.classList && firstChild.classList.contains('no-conversations')) {
        conversationList.innerHTML = '';
      }
      conversationList.insertBefore(div, conversationList.firstChild);
    }

    // Switch to a different conversation
    function switchConversation(convoId) {
      if (currentConvoId === convoId) return;

      currentConvoId = convoId;
      currentConvoIdEl.textContent = convoId.replace('chat-', 'Chat #');
      messagesEl.innerHTML = '';

      // Update active state in sidebar
      document.querySelectorAll('.conversation-item').forEach(item => {
        item.classList.remove('active');
      });
      const activeItem = document.querySelector(`[data-convo-id="${convoId}"]`);
      if (activeItem) {
        activeItem.classList.add('active');
      }

      // Rejoin with new conversation ID
      socket.emit('join', { convoId, user: userId });
    }

    // Create new chat session
    newChatBtn.onclick = async () => {
      const newConvoId = generateConvoId();

      // Immediately add to sidebar
      addConversationToList({
        convoId: newConvoId,
        messageCount: 0,
        lastMessage: 'New conversation',
        lastMessageTime: new Date(),
        hasDocuments: false
      });

      // Switch to it
      switchConversation(newConvoId);
    };

    // Socket.io event handlers
    socket.on('connect', () => {
      if (!currentConvoId) {
        currentConvoId = generateConvoId();
        currentConvoIdEl.textContent = currentConvoId.replace('chat-', 'Chat #');
      }
      socket.emit('join', { convoId: currentConvoId, user: userId });
      loadConversations();
    });

    socket.on('history', (history) => {
      messagesEl.innerHTML = '';
      history.forEach(m => appendMessage(m));
    });

    socket.on('new_message', (m) => {
      appendMessage(m);

      // Update conversation in sidebar
      addConversationToList({
        convoId: currentConvoId,
        messageCount: document.querySelectorAll('.message').length,
        lastMessage: m.message,
        lastMessageTime: new Date(),
        hasDocuments: false
      });
    });

    socket.on('clear_history', () => {
      messagesEl.innerHTML = '';
    });

    // Send message
    function sendMessage() {
      const text = inputEl.value.trim();
      if (!text) return;
      socket.emit('send_message', { convoId: currentConvoId, message: text, sender: 'user' });
      inputEl.value = '';
    }

    sendBtn.onclick = sendMessage;
    inputEl.onkeypress = (e) => {
      if (e.key === 'Enter') sendMessage();
    };

    // Upload documents
    uploadForm.onsubmit = async (e) => {
      e.preventDefault();
      const filesInput = document.getElementById('files');
      const files = filesInput.files;
      if (!files.length) {
        uploadStatus.textContent = 'No files selected.';
        return;
      }
      const formData = new FormData();
      for (let i = 0; i < files.length; i++) {
        formData.append('files', files[i]);
      }
      formData.append('userId', userId);
      formData.append('convoId', currentConvoId); // Send current conversation ID
      uploadStatus.textContent = 'Uploading...';
      try {
        const res = await fetch(`${API_URL}/upload`, {
          method: 'POST',
          body: formData
        });
        const data = await res.json();
        if (data.results) {
          uploadStatus.innerHTML = '<b>‚úÖ Upload Results:</b><br>' + data.results.map(r =>
            `${r.file}: ${r.status}${r.error ? ' - ' + r.error : ''} (${r.words || ''} words, ${r.chunks || ''} chunks)`
          ).join('<br>');
          filesInput.value = '';
        } else if (data.error) {
          uploadStatus.textContent = '‚ùå Upload failed: ' + data.error;
        } else {
          uploadStatus.textContent = '‚ùå Upload failed.';
        }
      } catch (err) {
        uploadStatus.textContent = '‚ùå Error uploading files.';
      }
    };

    // Append message to chat
    function appendMessage(m) {
      const div = document.createElement('div');
      div.className = `message ${m.sender}`;

      const ragInfo = m.metadata?.ragContext
        ? ` | <span style="color: #27ae60;">üîç RAG: ${m.metadata.chunks} chunks</span>`
        : '';

      div.innerHTML = `
        <div class="message-header">${m.sender === 'user' ? 'You' : 'Bot'}${ragInfo}</div>
        <div class="message-content">${escapeHtml(m.message)}</div>
        <div class="message-meta">${new Date(m.ts).toLocaleTimeString()}</div>
      `;
      messagesEl.appendChild(div);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    // Escape HTML to prevent XSS
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Initial load
    loadConversations();
  </script>
</body>
</html>
